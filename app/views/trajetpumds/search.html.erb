<script src="//maps.google.com/maps/api/js?v=3.exp&key=AIzaSyBngIsRw-Abk5UB04-Nl_Qg4vACEfo2jEo"></script>
<div class="searchpage">
<div class="col-xs-12 text-center">

<div class="col-xs-12 col-md-7">

  <h1 class="text-center searchtitle">Les pickeurs autour de <%= if @par == nil || @par=="" then "vous" else @par end %></h1>
</div>

<%= form_tag trajetpumds_search_path, method: :post, class: "form-inline col-xs-12 col-md-5 searchform" do %>
<div class="form-group searchgroup">

  <%= text_field_tag(
  :custom_address,
  params[:custom_address],
  placeholder: "rue, code postal et ville",
  class: "form-control searchbar"
    ) %>
    <%= button_tag(type:'submit', class: "btn btn-lg btn-search") do%>
    <i class="fa fa-search">
      Rechercher</i>
      <% end %>
    </div>
    <% end %>
  </div>

  <aside class="markersbloc hidden-xs hidden-sm">
    <ul id="markerslist" class="list-unstyled"></ul>
  </aside>

      <div id="mapcontainer">
        <div id="map"></div>
      </div>
</div>




          <script type="text/javascript">
function chgbtn() {
  $('.dateselect').each(function () {
    $(this).on('change', function () {
      if($(this).find('option:selected').val()==="0"){
        $(this).nextAll('.btn-search:first').prop('disabled',true);
        $(this).nextAll('.btn-search:first').prop('value',"Complet");
      }
      else{
        $(this).nextAll('.btn-search:first').prop('disabled',false)
        $(this).nextAll('.btn-search:first').prop('value',"Pick up my drive");
      };
    }).trigger('change');
  });
};



          var pickers = <%= @pickers %>;
          var pickerscoord = <%= @pickerscoord %>;
          var avatars = <%= raw @pickersavatars %>;
          var infotrajets = <%=raw @trajetsdata %>;
          var ul = document.getElementById("markerslist");
          function initMap() {
      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 15,
        center: {lat: <%= @lati %>, lng: <%= @longi %>}
      });

      setMarkers(map);
    }

    // Data for the markers consisting of a name, a LatLng and a zIndex for the
    // order in which these markers should display on top of each other.



    function setMarkers(map) {

      <%=  @pickers.count.times do |i| %>
          var i = <%= i %>;
          var pcoord = pickerscoord[i];
          var contentString = infotrajets[i];
          var image = {
            url: avatars[i].replace(/&quot;/g, '\\"'),
            // This marker is 20 pixels wide by 32 pixels high.
            size: new google.maps.Size(32, 32),
            // The origin for this image is (0, 0).
            origin: new google.maps.Point(0, 0),
            // The anchor for this image is the base of the flagpole at (0, 32).
            anchor: new google.maps.Point(0, 32)
          };
          var marker<%= i %> = new google.maps.Marker({
            position: {lat: pcoord[0], lng: pcoord[1]},
            map: map,
            icon: image,
          });
          var infowindow<%= i %> = new google.maps.InfoWindow({
            content: contentString

          });

          function createMarkerButton(marker) {
            //Creates a sidebar button
            var li<%= i %> = document.createElement("li");
            li<%= i %>.setAttribute("id", "itemlist<%= i %>");
            li<%= i %>.innerHTML = "<div class='container-fluide'><div class='row'>" + contentString + "</div></div>";
            ul.appendChild(li<%= i %>);
            console.log( li<%= i %>)

            //Trigger a click event to marker when the button is clicked.
            google.maps.event.addDomListener(li<%= i %>, "click", function(){
              google.maps.event.trigger(marker, "click");
              chgbtn();
            });
          };

          google.maps.event.addListener(marker<%= i %>, "click", function(){
            infowindow<%= i %>.open(map, marker<%= i %>);
            chgbtn();
          });
          if (i>0){
            createMarkerButton(marker<%= i %>);
          }
      <%   end%>
    };
initMap();
$('.gm-style-iw').addClass("container-fluid");
$('.gm-style-iw div').addClass("row");
</script>
<script type="text/javascript">
$(document).ready(chgbtn());

</script>
